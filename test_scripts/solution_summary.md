# 通义千问API调用问题解决方案

## 问题描述

通义千问API在调用时返回404错误，无法成功生成架构大纲。

从日志中可以看到：
```
2025-06-03 22:45:58,109 - AIService - INFO - 通义千问v1 API返回404，尝试v2端点
2025-06-03 22:45:58,676 - AIService - INFO - 通义千问API响应状态码: 404
2025-06-03 22:45:58,676 - AIService - ERROR - 通义千问API请求失败:
```

## 解决方案

通过测试多种API调用方式，我们发现通义千问的兼容模式API可以成功工作。解决方案包含以下几个方面：

### 1. 修改`tongyi_client.py`

- 默认使用兼容模式API（`use_openai_client=True`）
- 调整API超时时间至180秒，以适应较长的响应时间
- 增加API调用失败时的回退机制，从标准API失败时自动切换到兼容模式API
- 更新API URL路径，确保使用正确的端点

### 2. 修改`app/utils/ai_service.py`中的通义千问调用部分

- 直接使用兼容模式API格式调用
- 调整请求体格式，符合兼容模式API的要求
- 修改响应处理逻辑，优先处理兼容模式API的响应格式
- 增加超时时间至180秒
- 改进错误处理和日志记录

### 3. 优化所有生成功能的工作流程

修改了所有生成功能，使其都先调用通义千问生成大纲并在控制台显示，再调用DeepSeek生成具体内容：

- **架构代码生成**：通义千问生成架构大纲，DeepSeek生成具体代码
- **数据库设计**：通义千问生成数据库设计大纲，DeepSeek生成具体SQL脚本
- **模块代码**：通义千问生成模块设计大纲，DeepSeek生成具体模块代码
- **测试用例**：通义千问生成测试大纲，DeepSeek生成具体测试用例
- **部署步骤**：通义千问生成部署大纲，DeepSeek生成具体部署步骤

每个功能都添加了相应的回退机制，当DeepSeek生成失败时，使用通义千问作为备选方案。

## 测试结果

通过测试，确认修改后的通义千问客户端能够成功生成各种大纲：

- 兼容模式API (`https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions`) 在所有功能中均正常工作
- 生成的大纲格式正确，并能显示在控制台
- DeepSeek能够基于这些大纲生成更详细的代码和内容

## 现在的工作流程

现在系统的整体工作流程为：
1. 用通义千问生成大纲（架构、数据库、模块、测试或部署）
2. 输出大纲到控制台
3. 用DeepSeek生成具体内容（代码、SQL脚本、测试用例、部署步骤等）
4. 显示生成的内容到页面

## 后续建议

1. 定期关注通义千问API的更新，及时调整调用方式
2. 考虑添加API负载均衡或自动重试机制，以提高系统稳定性
3. 完善错误处理和用户反馈，在API调用失败时提供更友好的提示
4. 考虑添加缓存机制，避免重复生成相似内容
5. 增加用户对大纲的编辑和确认功能，让用户可以在生成具体内容前修改大纲 